name: ğŸš€ è‡ªåŠ¨å‘å¸ƒä¸ç‰ˆæœ¬ç®¡ç†

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # æ„å»ºå’Œæµ‹è¯•
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ç”¨äºç”Ÿæˆ changelog

      - name: ğŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¥ å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸ” ä»£ç æ£€æŸ¥
        run: npm run lint

      - name: ğŸ—ï¸ æ„å»ºé¡¹ç›®
        run: npm run build
        env:
          NEXT_PUBLIC_APP_VERSION: ${{ github.sha }}

  # å‘å¸ƒç‰ˆæœ¬ï¼ˆä»…åœ¨ main åˆ†æ”¯æ¨é€æ—¶æ‰§è¡Œï¼‰
  release:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¥ å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸ·ï¸ ç”Ÿæˆç‰ˆæœ¬å·
        id: version
        run: |
          # è·å–æœ€æ–°æ ‡ç­¾
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Latest tag: $LATEST_TAG"
          
          # è§£æç‰ˆæœ¬å·
          VERSION=${LATEST_TAG#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          
          # æ ¹æ®æäº¤ç±»å‹å†³å®šç‰ˆæœ¬å·å¢é‡
          COMMIT_MSG=$(git log -1 --pretty=%B)
          if [[ $COMMIT_MSG == *"feat:"* ]] || [[ $COMMIT_MSG == *"feat("* ]]; then
            MINOR=$((MINOR + 1))
            PATCH=0
          elif [[ $COMMIT_MSG == *"fix:"* ]] || [[ $COMMIT_MSG == *"fix("* ]]; then
            PATCH=$((PATCH + 1))
          else
            PATCH=$((PATCH + 1))
          fi
          
          NEW_VERSION="v$MAJOR.$MINOR.$PATCH"
          echo "New version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: ğŸ“ ç”Ÿæˆ CHANGELOG
        id: changelog
        run: |
          # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          
          if [ -n "$PREVIOUS_TAG" ]; then
            # ç”Ÿæˆä»ä¸Šä¸€ä¸ªæ ‡ç­¾åˆ°ç°åœ¨çš„å˜æ›´æ—¥å¿—
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..HEAD)
          else
            # å¦‚æœæ²¡æœ‰ä¸Šä¸€ä¸ªæ ‡ç­¾ï¼Œæ˜¾ç¤ºæœ€è¿‘çš„æäº¤
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" -10)
          fi
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "## ${{ steps.version.outputs.version }} ($(date +'%Y-%m-%d'))" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "### ğŸš€ æ–°åŠŸèƒ½" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" | grep -E "feat:|feat\(" || echo "- æ— æ–°åŠŸèƒ½" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "### ğŸ› ä¿®å¤" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" | grep -E "fix:|fix\(" || echo "- æ— ä¿®å¤" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "### ğŸ“ å…¶ä»–å˜æ›´" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" | grep -vE "feat:|fix:|feat\(|fix\(" || echo "- æ— å…¶ä»–å˜æ›´" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸ·ï¸ åˆ›å»º Git æ ‡ç­¾
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag -a "${{ steps.version.outputs.version }}" -m "Release ${{ steps.version.outputs.version }}"
          git push origin "${{ steps.version.outputs.version }}"

      - name: ğŸ“ æ›´æ–° CHANGELOG.md
        run: |
          # åœ¨æ–‡ä»¶å¼€å¤´æ’å…¥æ–°çš„å˜æ›´æ—¥å¿—
          {
            echo "${{ steps.changelog.outputs.changelog }}"
            echo ""
            if [ -f CHANGELOG.md ]; then
              cat CHANGELOG.md
            fi
          } > CHANGELOG_TEMP.md
          mv CHANGELOG_TEMP.md CHANGELOG.md
          
          # æäº¤ CHANGELOG.md
          git add CHANGELOG.md
          git commit -m "docs: æ›´æ–° CHANGELOG.md for ${{ steps.version.outputs.version }}" || exit 0
          git push origin main

      - name: ğŸš€ åˆ›å»º GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.version }}
          release_name: Release ${{ steps.version.outputs.version }}
          body: |
            ${{ steps.changelog.outputs.changelog }}
            
            ## ğŸ”„ å›æ»šæŒ‡å—
            
            å¦‚æœæ­¤ç‰ˆæœ¬å‡ºç°é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å¿«é€Ÿå›æ»šï¼š
            
            ### Vercel å›æ»š
            ```bash
            # æŸ¥çœ‹éƒ¨ç½²å†å²
            vercel ls
            
            # å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
            vercel promote <previous_deployment_id>
            ```
            
            ### Git å›æ»š
            ```bash
            # å›æ»šåˆ°ä¸Šä¸€ä¸ªæäº¤
            git revert -m 1 <merge_sha>
            git push origin main
            ```
            
            ### æ•°æ®åº“å›æ»š
            ```bash
            # æ¢å¤æ•°æ®åº“åˆ°ä¸Šä¸€ä¸ªå¤‡ä»½
            ./scripts/restore_db.sh backups/backup_YYYYMMDD_HHMMSS.sql
            ```
          draft: false
          prerelease: false

  # æ•°æ®åº“å¤‡ä»½ï¼ˆä»…åœ¨ main åˆ†æ”¯æ¨é€æ—¶æ‰§è¡Œï¼‰
  backup-database:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ—„ï¸ æ•°æ®åº“å¤‡ä»½
        run: |
          # åˆ›å»ºå¤‡ä»½ç›®å½•
          mkdir -p backups
          
          # ç”Ÿæˆå¤‡ä»½æ–‡ä»¶å
          BACKUP_FILE="backup_$(date +%Y%m%d_%H%M%S).sql"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®åº“è¿æ¥ä¿¡æ¯
          if [ -n "${{ secrets.SUPABASE_DB_URL }}" ]; then
            echo "æ­£åœ¨å¤‡ä»½æ•°æ®åº“..."
            # è¿™é‡Œéœ€è¦æ ¹æ®å®é™…çš„ Supabase è¿æ¥æ–¹å¼è°ƒæ•´
            echo "-- æ•°æ®åº“å¤‡ä»½æ–‡ä»¶" > backups/$BACKUP_FILE
            echo "-- æ—¶é—´: $(date)" >> backups/$BACKUP_FILE
            echo "-- ç‰ˆæœ¬: ${{ github.sha }}" >> backups/$BACKUP_FILE
            echo "-- æ³¨æ„: è¯·æ‰‹åŠ¨æ‰§è¡Œæ•°æ®åº“å¤‡ä»½è„šæœ¬" >> backups/$BACKUP_FILE
          else
            echo "âš ï¸ æœªé…ç½® SUPABASE_DB_URLï¼Œè·³è¿‡æ•°æ®åº“å¤‡ä»½"
          fi

      - name: ğŸ“¤ ä¸Šä¼ å¤‡ä»½æ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: database-backup-${{ github.sha }}
          path: backups/
          retention-days: 30
