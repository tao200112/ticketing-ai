# 商家登录 Supabase 配置说明

## 🔍 问题检查

根据代码分析，商家登录API存在以下关键点：

### 1. API使用的Supabase密钥
```javascript
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY
```

**重要说明**：
- ✅ **SUPABASE_SERVICE_ROLE_KEY**：会绕过所有RLS策略，推荐使用
- ⚠️ **NEXT_PUBLIC_SUPABASE_ANON_KEY**：受RLS策略限制，可能导致登录失败

### 2. 登录API执行的查询

登录API需要查询以下表：
1. `users` - 查找商家用户（`role = 'merchant'`）
2. `merchants` - 查找商家信息（`owner_user_id = user.id`）
3. `merchant_members` - 查找员工信息（`user_id = user.id`）

### 3. 潜在的RLS问题

如果以下表启用了RLS，并且使用的是ANON_KEY（而非SERVICE_ROLE_KEY），可能会被阻止：

#### users表
- 如果有策略：`auth.uid() = id`，会阻止查询所有商家用户
- 需要策略：允许查询 `role = 'merchant'` 的用户

#### merchants表
- 如果有策略：`owner_user_id = auth.uid()`，会阻止查询其他商家的信息
- 使用SERVICE_ROLE_KEY时不受影响

#### merchant_members表
- 如果有策略：`user_id = auth.uid()`，会阻止查询其他用户的成员关系
- 使用SERVICE_ROLE_KEY时不受影响

## ✅ 解决方案

### 方案1：确保使用SERVICE_ROLE_KEY（推荐）

在 `.env.local` 或 Vercel 环境变量中设置：
```
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key_here
```

这样API会绕过所有RLS策略，登录功能正常工作。

### 方案2：更新RLS策略

如果必须使用ANON_KEY，请运行以下SQL迁移：

```sql
-- 文件：supabase/migrations/fix_merchant_login_rls.sql
-- 在 Supabase SQL Editor 中运行
```

这个迁移会：
1. 检查users表的RLS状态
2. 如果启用RLS，添加允许登录API查询的策略
3. 同样处理merchants和merchant_members表

## 📋 检查步骤

### 1. 检查环境变量

确认以下环境变量已设置：
- `NEXT_PUBLIC_SUPABASE_URL`
- `SUPABASE_SERVICE_ROLE_KEY`（推荐）或 `NEXT_PUBLIC_SUPABASE_ANON_KEY`

### 2. 检查数据库RLS状态

在 Supabase SQL Editor 中运行：
```sql
SELECT 
  tablename, 
  rowsecurity as rls_enabled
FROM pg_tables 
WHERE schemaname = 'public' 
AND tablename IN ('users', 'merchants', 'merchant_members');
```

### 3. 运行修复迁移

如果users表启用了RLS，运行：
```sql
-- 在 Supabase SQL Editor 中运行
\i supabase/migrations/fix_merchant_login_rls.sql
```

或者直接复制 `fix_merchant_login_rls.sql` 的内容到 Supabase SQL Editor 执行。

### 4. 测试登录

使用商家账号测试登录功能，检查：
- 是否能成功查询到用户
- 是否能成功查询到商家信息
- 是否能成功查询到员工信息（如果有）

## 🔧 快速修复（推荐）

**最简单的方法**：确保设置了 `SUPABASE_SERVICE_ROLE_KEY`

1. 在 Supabase Dashboard 中：
   - Settings → API
   - 复制 `service_role` 密钥（注意：这是secret key，不要公开）

2. 在 Vercel 环境变量中：
   - 添加 `SUPABASE_SERVICE_ROLE_KEY`
   - 值设为复制的service_role密钥

3. 重新部署应用

这样登录API会绕过所有RLS策略，正常工作。

## 📝 注意事项

1. **SERVICE_ROLE_KEY是secret**：
   - 只应该在服务端使用（API路由）
   - 不要暴露给客户端
   - 不要在Git仓库中提交

2. **ANON_KEY vs SERVICE_ROLE_KEY**：
   - ANON_KEY：客户端使用，受RLS限制
   - SERVICE_ROLE_KEY：服务端使用，绕过RLS

3. **RLS策略**：
   - 如果使用SERVICE_ROLE_KEY，RLS策略不影响服务端API
   - 如果使用ANON_KEY，需要确保RLS策略允许登录查询

## 🚀 验证

登录成功后，检查返回的用户数据：
```json
{
  "success": true,
  "user": {
    "id": "...",
    "email": "...",
    "merchant_id": "...",
    "merchant_role": "boss"
  }
}
```

如果登录失败，查看控制台日志：
- `🔍 查询用户结果` - 检查是否能查询到用户
- `🏪 找到商家（owner）` 或 `🏪 找到商家（员工）` - 检查是否能查询到商家

