# 数据库结构诊断报告

## 问题分析

**错误信息**: `column user_id does not exist`

**根本原因**: merchants 表中用于关联用户的外键列名是 `owner_user_id`，而不是 `user_id`。

## 数据库结构分析

### 1. Merchants 表实际结构

根据 `supabase/migrations/partytix_mvp.sql` 和 `supabase/migrations/partytix_updated_schema.sql`：

```sql
CREATE TABLE IF NOT EXISTS merchants (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  owner_user_id UUID REFERENCES users(id) ON DELETE SET NULL,  -- 这是正确的外键列名
  name TEXT NOT NULL,
  description TEXT,
  logo_url TEXT,
  website_url TEXT,
  contact_email TEXT,
  verified BOOLEAN DEFAULT FALSE,
  status TEXT DEFAULT 'active' CHECK (status IN ('active', 'inactive', 'suspended')),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 2. 关键发现

- **正确的外键列名**: `owner_user_id` (不是 `user_id`)
- **ID 列类型**: `UUID` (正确)
- **外键约束**: `REFERENCES users(id) ON DELETE SET NULL`

### 3. 其他表的外键结构

- **events 表**: `merchant_id` → `merchants(id)`
- **orders 表**: `user_id` → `users(id)`, `merchant_id` → `merchants(id)`
- **tickets 表**: `user_id` → `users(id)`, `merchant_id` → `merchants(id)`

## 修正前后对比

### 修正前（错误的 RLS 策略）
```sql
-- 错误：使用了不存在的 user_id 列
CREATE POLICY "Merchants can manage their own business" ON merchants
    FOR ALL USING (user_id = auth.uid());
```

### 修正后（正确的 RLS 策略）
```sql
-- 正确：使用实际存在的 owner_user_id 列
CREATE POLICY "Merchants can manage their own business" ON merchants
    FOR ALL USING (owner_user_id = auth.uid());
```

## 影响范围

1. **merchants 表的所有 RLS 策略**需要更新
2. **events 表策略**中引用 merchants 的部分需要更新
3. **prices 表策略**中引用 merchants 的部分需要更新

## 建议

1. 使用生成的 `enable_rls_policies_fixed.sql` 文件
2. 在 Supabase SQL Editor 中执行
3. 测试所有用户角色的权限
4. 验证数据访问控制是否按预期工作
