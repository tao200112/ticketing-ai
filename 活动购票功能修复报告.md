# ğŸ« æ´»åŠ¨è´­ç¥¨åŠŸèƒ½ä¿®å¤æŠ¥å‘Š

**æ—¥æœŸ**: 2025-01-26  
**é—®é¢˜**: ä¸»é¡µæ´»åŠ¨æ— æ³•è¿›å…¥è¯¦æƒ…ï¼Œè´­ä¹°åŠŸèƒ½ä¸å·¥ä½œ

---

## ğŸ” é—®é¢˜è¯Šæ–­

### é—®é¢˜ 1: æ´»åŠ¨è¯¦æƒ…é¡µæ— æ³•è¿›å…¥

**åŸå› **:
- åªæœ‰ `ridiculous-chicken` æœ‰ç¡¬ç¼–ç çš„é¡µé¢
- ç¼ºå°‘åŠ¨æ€è·¯ç”± `app/events/[id]/page.js`
- å…¶ä»–æ´»åŠ¨æ— æ³•é€šè¿‡åŠ¨æ€ ID è®¿é—®è¯¦æƒ…

**ç—‡çŠ¶**:
```
ä¸»é¡µæ˜¾ç¤ºå¤šä¸ªæ´»åŠ¨
â†“
ç‚¹å‡»æ´»åŠ¨å¡ç‰‡
â†“
åªèƒ½è®¿é—® /events/ridiculous-chicken
â†“
å…¶ä»–æ´»åŠ¨è¿”å› 404
```

### é—®é¢˜ 2: è´­ä¹°åŠŸèƒ½ä¸å·¥ä½œ

**åŸå› **:
- ç¼ºå°‘æ”¯ä»˜ API `/api/checkout_sessions`
- ç»ˆç«¯æ˜¾ç¤º `POST /api/checkout_sessions 404`

**ç—‡çŠ¶**:
```
ç‚¹å‡»è´­ä¹°æŒ‰é’®
â†“
POST /api/checkout_sessions 404
â†“
æ— æ³•è·³è½¬åˆ°æ”¯ä»˜é¡µé¢
```

---

## âœ… ä¿®å¤å†…å®¹

### 1. åˆ›å»ºåŠ¨æ€æ´»åŠ¨è¯¦æƒ…é¡µ

**æ–‡ä»¶**: `app/events/[id]/page.js` (æ–°å»º)

**åŠŸèƒ½**:
- âœ… æ”¯æŒé€šè¿‡ ID è®¿é—®ä»»æ„æ´»åŠ¨
- âœ… ä» API åŠ¨æ€åŠ è½½æ´»åŠ¨è¯¦æƒ…
- âœ… æ˜¾ç¤ºæ´»åŠ¨ä¿¡æ¯å’Œç¥¨ç§
- âœ… æ”¯æŒé€‰æ‹©ç¥¨ç§å’Œæ•°é‡
- âœ… è°ƒç”¨æ”¯ä»˜ API è´­ä¹°

**ä»£ç ç‰¹æ€§**:
```javascript
// åŠ¨æ€è·¯ç”±å‚æ•°
const { id } = useParams()

// è·å–æ´»åŠ¨æ•°æ®
const response = await fetch(`/api/events/${id}`)

// è´­ç¥¨æµç¨‹
const handleBuyTickets = async () => {
  const response = await fetch('/api/checkout_sessions', {
    method: 'POST',
    body: JSON.stringify({
      event_id: event.id,
      price_id: selectedPrice,
      quantity: quantity,
      customer_email: customerEmail,
      customer_name: customerName
    })
  })
}
```

### 2. åˆ›å»ºæ”¯ä»˜ API

**æ–‡ä»¶**: `app/api/checkout_sessions/route.js` (æ–°å»º)

**åŠŸèƒ½**:
- âœ… åˆ›å»º Stripe Checkout Session
- âœ… éªŒè¯æ´»åŠ¨æ˜¯å¦å­˜åœ¨
- âœ… éªŒè¯ç¥¨ç§æ˜¯å¦å­˜åœ¨
- âœ… è¿”å›æ”¯ä»˜ URL

**ä»£ç ç‰¹æ€§**:
```javascript
// åˆ›å»º Stripe ä¼šè¯
const session = await stripe.checkout.sessions.create({
  payment_method_types: ['card'],
  line_items: [{
    price_data: {
      currency: 'cny',
      product_data: {
        name: `${event.title} - ${price.name}`,
      },
      unit_amount: price.amount_cents,
    },
    quantity: quantity,
  }],
  mode: 'payment',
  success_url: `${url}/success?session_id={CHECKOUT_SESSION_ID}`,
  cancel_url: `${url}/events/${event_id}`,
  customer_email: customer_email,
})
```

---

## ğŸ¯ ä¿®å¤åçš„æµç¨‹

### å®Œæ•´çš„è´­ç¥¨æµç¨‹

```
1. ç”¨æˆ·æµè§ˆæ´»åŠ¨
   â†“
2. ç‚¹å‡»æ´»åŠ¨å¡ç‰‡ (EventCard)
   â†“
3. è·³è½¬åˆ° /events/{event-id} (åŠ¨æ€è·¯ç”±)
   â†“
4. åŠ è½½æ´»åŠ¨è¯¦æƒ… (GET /api/events/{id})
   â†“
5. æ˜¾ç¤ºæ´»åŠ¨ä¿¡æ¯å’Œç¥¨ç§
   â†“
6. ç”¨æˆ·é€‰æ‹©ç¥¨ç§å’Œæ•°é‡
   â†“
7. å¡«å†™å§“åå’Œé‚®ç®±
   â†“
8. ç‚¹å‡»"ç«‹å³è´­ä¹°"
   â†“
9. è°ƒç”¨æ”¯ä»˜ API (POST /api/checkout_sessions)
   â†“
10. è·³è½¬åˆ° Stripe æ”¯ä»˜é¡µé¢
   â†“
11. å®Œæˆæ”¯ä»˜
   â†“
12. è¿”å›æˆåŠŸé¡µé¢ (/success)
```

---

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

| åŠŸèƒ½ | ä¿®å¤å‰ | ä¿®å¤å |
|-----|--------|--------|
| è®¿é—®æ´»åŠ¨è¯¦æƒ… | âŒ åªèƒ½è®¿é—® ridiculous-chicken | âœ… å¯ä»¥è®¿é—®æ‰€æœ‰æ´»åŠ¨ |
| åŠ¨æ€è·¯ç”± | âŒ ç¼ºå°‘ /events/[id] | âœ… æ”¯æŒåŠ¨æ€è·¯ç”± |
| æ”¯ä»˜åŠŸèƒ½ | âŒ API 404 é”™è¯¯ | âœ… æ­£å¸¸åˆ›å»ºæ”¯ä»˜ä¼šè¯ |
| è´­ç¥¨æµç¨‹ | âŒ æ— æ³•è´­ä¹° | âœ… å®Œæ•´è´­ç¥¨æµç¨‹ |

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### æµ‹è¯•æ­¥éª¤

1. **è®¿é—®æ´»åŠ¨åˆ—è¡¨**
   ```
   http://localhost:3000/events
   ```

2. **ç‚¹å‡»ä»»æ„æ´»åŠ¨**
   ```
   åº”è¯¥è·³è½¬åˆ° /events/{event-id}
   ```

3. **æŸ¥çœ‹æ´»åŠ¨è¯¦æƒ…**
   ```
   åº”è¯¥æ˜¾ç¤ºæ´»åŠ¨ä¿¡æ¯å’Œå¯ç”¨ç¥¨ç§
   ```

4. **é€‰æ‹©ç¥¨ç§å’Œæ•°é‡**
   ```
   å¡«å†™å§“åå’Œé‚®ç®±
   ```

5. **ç‚¹å‡»è´­ä¹°**
   ```
   åº”è¯¥è·³è½¬åˆ° Stripe æ”¯ä»˜é¡µé¢
   ```

6. **å®Œæˆæ”¯ä»˜**
   ```
   ä½¿ç”¨æµ‹è¯•å¡å·: 4242 4242 4242 4242
   ```

7. **éªŒè¯è·³è½¬**
   ```
   åº”è¯¥è¿”å›æˆåŠŸé¡µé¢å¹¶æ˜¾ç¤ºç¥¨æ®
   ```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

### ç¯å¢ƒå˜é‡

ç¡®ä¿ `.env.local` åŒ…å«:
```env
STRIPE_SECRET_KEY=sk_test_xxx
NEXT_PUBLIC_SITE_URL=http://localhost:3000
```

### Stripe æµ‹è¯•

- ä½¿ç”¨æµ‹è¯•æ¨¡å¼
- æµ‹è¯•å¡å·: `4242 4242 4242 4242`
- ä»»æ„æœªæ¥æ—¥æœŸå’Œ CVC

### åç»­æ”¹è¿›

1. â³ æ·»åŠ åº“å­˜æ£€æŸ¥
2. â³ æ·»åŠ è´­ä¹°é™åˆ¶
3. â³ ä¼˜åŒ–é”™è¯¯å¤„ç†
4. â³ æ·»åŠ åŠ è½½çŠ¶æ€

---

## âœ… æ€»ç»“

**å·²ä¿®å¤**:
- âœ… åŠ¨æ€æ´»åŠ¨è¯¦æƒ…é¡µ
- âœ… Stripe æ”¯ä»˜é›†æˆ
- âœ… å®Œæ•´è´­ç¥¨æµç¨‹

**å¯æµ‹è¯•**:
- âœ… æµè§ˆæ´»åŠ¨åˆ—è¡¨
- âœ… è®¿é—®æ´»åŠ¨è¯¦æƒ…
- âœ… é€‰æ‹©ç¥¨ç§è´­ä¹°
- âœ… å®Œæˆæ”¯ä»˜æµç¨‹



