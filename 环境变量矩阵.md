# 🔧 环境变量矩阵

**项目**: Partytix MVP - 票务系统  
**版本**: 1.0.0  
**日期**: 2024年12月

---

## 📋 环境变量概览

| 变量名 | 作用域 | 所有者 | 最小权限 | 本地 | 预发 | 生产 |
|--------|--------|--------|----------|------|------|------|
| `NODE_ENV` | 全局 | 系统 | 只读 | `development` | `staging` | `production` |
| `PORT` | 后端 | 后端服务 | 读写 | `3001` | `3001` | `3001` |
| `FRONTEND_PORT` | 前端 | 前端服务 | 读写 | `3000` | `3000` | `3000` |
| `SUPABASE_URL` | 后端 | 后端服务 | 只读 | `https://xxx.supabase.co` | `https://xxx.supabase.co` | `https://xxx.supabase.co` |
| `SUPABASE_ANON_KEY` | 前端 | 前端服务 | 只读 | `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...` | `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...` | `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...` |
| `SUPABASE_SERVICE_ROLE_KEY` | 后端 | 后端服务 | 读写 | `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...` | `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...` | `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...` |
| `JWT_SECRET` | 后端 | 后端服务 | 读写 | `dev-jwt-secret` | `staging-jwt-secret` | `prod-jwt-secret` |
| `JWT_EXPIRES_IN` | 后端 | 后端服务 | 只读 | `24h` | `24h` | `24h` |
| `JWT_REFRESH_EXPIRES_IN` | 后端 | 后端服务 | 只读 | `7d` | `7d` | `7d` |
| `BCRYPT_SALT_ROUNDS` | 后端 | 后端服务 | 只读 | `10` | `12` | `12` |
| `STRIPE_SECRET_KEY` | 后端 | 后端服务 | 读写 | `sk_test_...` | `sk_test_...` | `sk_live_...` |
| `STRIPE_PUBLISHABLE_KEY` | 前端 | 前端服务 | 只读 | `pk_test_...` | `pk_test_...` | `pk_live_...` |
| `STRIPE_WEBHOOK_SECRET` | 后端 | 后端服务 | 只读 | `whsec_test_...` | `whsec_test_...` | `whsec_live_...` |
| `CORS_ORIGIN` | 后端 | 后端服务 | 只读 | `http://localhost:3000` | `https://staging.partytix.com` | `https://partytix.com` |
| `CORS_CREDENTIALS` | 后端 | 后端服务 | 只读 | `true` | `true` | `true` |
| `RATE_LIMIT_MAX_REQUESTS` | 后端 | 后端服务 | 只读 | `1000` | `1000` | `1000` |
| `RATE_LIMIT_WINDOW_MS` | 后端 | 后端服务 | 只读 | `900000` | `900000` | `900000` |
| `LOG_LEVEL` | 全局 | 系统 | 只读 | `debug` | `info` | `info` |
| `LOG_FILE` | 全局 | 系统 | 读写 | `logs/app.log` | `logs/app.log` | `logs/app.log` |
| `LOG_MAX_SIZE` | 全局 | 系统 | 只读 | `10m` | `10m` | `10m` |
| `LOG_MAX_FILES` | 全局 | 系统 | 只读 | `5` | `5` | `5` |
| `MONITORING_ENABLED` | 全局 | 系统 | 只读 | `false` | `true` | `true` |
| `HEALTH_CHECK_INTERVAL` | 全局 | 系统 | 只读 | `30000` | `30000` | `30000` |
| `REDIS_URL` | 后端 | 后端服务 | 读写 | `redis://localhost:6379` | `redis://staging-redis:6379` | `redis://prod-redis:6379` |
| `CACHE_TTL` | 后端 | 后端服务 | 只读 | `3600` | `3600` | `3600` |
| `SMTP_HOST` | 后端 | 后端服务 | 只读 | `smtp.gmail.com` | `smtp.gmail.com` | `smtp.gmail.com` |
| `SMTP_PORT` | 后端 | 后端服务 | 只读 | `587` | `587` | `587` |
| `SMTP_USER` | 后端 | 后端服务 | 读写 | `dev@partytix.com` | `staging@partytix.com` | `noreply@partytix.com` |
| `SMTP_PASS` | 后端 | 后端服务 | 读写 | `dev-password` | `staging-password` | `prod-password` |
| `UPLOAD_MAX_SIZE` | 后端 | 后端服务 | 只读 | `10485760` | `10485760` | `10485760` |
| `UPLOAD_ALLOWED_TYPES` | 后端 | 后端服务 | 只读 | `image/jpeg,image/png` | `image/jpeg,image/png` | `image/jpeg,image/png` |
| `HELMET_ENABLED` | 后端 | 后端服务 | 只读 | `false` | `true` | `true` |
| `CSP_ENABLED` | 后端 | 后端服务 | 只读 | `false` | `true` | `true` |
| `HSTS_ENABLED` | 后端 | 后端服务 | 只读 | `false` | `true` | `true` |
| `NEXT_PUBLIC_API_URL` | 前端 | 前端服务 | 只读 | `http://localhost:3001/v1` | `https://staging-api.partytix.com/v1` | `https://api.partytix.com/v1` |
| `NEXT_PUBLIC_SITE_URL` | 前端 | 前端服务 | 只读 | `http://localhost:3000` | `https://staging.partytix.com` | `https://partytix.com` |
| `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY` | 前端 | 前端服务 | 只读 | `pk_test_...` | `pk_test_...` | `pk_live_...` |
| `ENVIRONMENT` | 全局 | 系统 | 只读 | `development` | `staging` | `production` |
| `VERSION` | 全局 | 系统 | 只读 | `1.0.0-dev` | `1.0.0-staging` | `1.0.0` |
| `BUILD_DATE` | 全局 | 系统 | 只读 | `2024-12-01` | `2024-12-01` | `2024-12-01` |

---

## 🔐 安全等级分类

### 🔴 高敏感 (High Sensitivity)
- `SUPABASE_SERVICE_ROLE_KEY` - 数据库完全访问权限
- `JWT_SECRET` - 身份验证密钥
- `STRIPE_SECRET_KEY` - 支付处理密钥
- `STRIPE_WEBHOOK_SECRET` - Webhook 验证密钥
- `SMTP_PASS` - 邮件服务密码

### 🟡 中敏感 (Medium Sensitivity)
- `SUPABASE_URL` - 数据库连接地址
- `SUPABASE_ANON_KEY` - 数据库匿名访问密钥
- `STRIPE_PUBLISHABLE_KEY` - 支付公钥
- `CORS_ORIGIN` - 跨域配置
- `REDIS_URL` - 缓存服务地址

### 🟢 低敏感 (Low Sensitivity)
- `NODE_ENV` - 环境标识
- `PORT` - 服务端口
- `LOG_LEVEL` - 日志级别
- `CACHE_TTL` - 缓存时间
- `VERSION` - 版本信息

---

## 🏗️ 环境配置策略

### 开发环境 (Development)
- **目标**: 快速开发和调试
- **安全**: 宽松的安全策略
- **监控**: 最小化监控
- **日志**: 详细调试日志
- **缓存**: 本地 Redis 或内存缓存

### 预发环境 (Staging)
- **目标**: 生产前测试
- **安全**: 接近生产的安全策略
- **监控**: 基本监控配置
- **日志**: 结构化日志
- **缓存**: 独立的 Redis 实例

### 生产环境 (Production)
- **目标**: 稳定运行
- **安全**: 最高安全策略
- **监控**: 完整监控体系
- **日志**: 生产级日志管理
- **缓存**: 高可用 Redis 集群

---

## 🔄 环境变量管理

### 本地开发
```bash
# 复制环境变量模板
cp env.example .env.local

# 编辑环境变量
nano .env.local

# 验证环境变量
npm run validate:env
```

### 预发环境
```bash
# 设置预发环境变量
export NODE_ENV=staging
export SUPABASE_URL=https://staging.supabase.co
export STRIPE_SECRET_KEY=sk_test_staging_key

# 部署到预发环境
npm run deploy:staging
```

### 生产环境
```bash
# 设置生产环境变量
export NODE_ENV=production
export SUPABASE_URL=https://prod.supabase.co
export STRIPE_SECRET_KEY=sk_live_prod_key

# 部署到生产环境
npm run deploy:production
```

---

## 🛡️ 安全最佳实践

### 1. 密钥管理
- 使用环境变量存储敏感信息
- 定期轮换密钥和密码
- 使用密钥管理服务 (如 AWS Secrets Manager)
- 避免在代码中硬编码敏感信息

### 2. 访问控制
- 最小权限原则
- 定期审查权限配置
- 使用角色基础访问控制 (RBAC)
- 监控异常访问行为

### 3. 加密传输
- 使用 HTTPS 传输敏感数据
- 启用 HSTS 强制 HTTPS
- 使用安全的 WebSocket 连接
- 验证 SSL 证书有效性

### 4. 审计日志
- 记录所有敏感操作
- 监控环境变量访问
- 定期审查日志文件
- 设置异常告警

---

## 📊 监控和告警

### 环境变量监控
- 监控环境变量加载状态
- 检测缺失的环境变量
- 验证环境变量格式
- 监控敏感变量访问

### 告警规则
- 环境变量加载失败
- 敏感变量异常访问
- 配置变更检测
- 安全策略违规

---

## 🔧 故障排查

### 常见问题
1. **环境变量未加载**
   - 检查文件路径和权限
   - 验证环境变量格式
   - 确认加载顺序

2. **敏感变量泄露**
   - 立即轮换相关密钥
   - 检查日志和监控
   - 更新安全策略

3. **配置不一致**
   - 对比不同环境配置
   - 检查部署脚本
   - 验证环境变量同步

### 调试工具
```bash
# 检查环境变量
npm run env:check

# 验证配置
npm run config:validate

# 测试连接
npm run test:connections
```

---

**文档版本**: 1.0.0  
**最后更新**: 2024年12月  
**审核状态**: ✅ 完成
