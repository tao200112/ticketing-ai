# 生产环境配置指南

## 环境变量配置

### Vercel 部署配置

1. **在 Vercel Dashboard 中设置环境变量**：
   - 进入项目设置 → Environment Variables
   - 添加以下环境变量：

```
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=your_stripe_publishable_key
STRIPE_SECRET_KEY=your_stripe_secret_key
STRIPE_WEBHOOK_SECRET=your_stripe_webhook_secret
NEXT_PUBLIC_APP_URL=https://your-domain.com
```

### Supabase 数据库配置

1. **启用 RLS 策略**：
   ```sql
   -- 启用所有表的 RLS
   ALTER TABLE users ENABLE ROW LEVEL SECURITY;
   ALTER TABLE merchants ENABLE ROW LEVEL SECURITY;
   ALTER TABLE events ENABLE ROW LEVEL SECURITY;
   ALTER TABLE orders ENABLE ROW LEVEL SECURITY;
   ALTER TABLE tickets ENABLE ROW LEVEL SECURITY;
   ALTER TABLE admin_invite_codes ENABLE ROW LEVEL SECURITY;
   ```

2. **创建 RLS 策略**：
   ```sql
   -- 用户只能访问自己的数据
   CREATE POLICY "Users can view own data" ON users
     FOR SELECT USING (auth.uid()::text = id);
   
   CREATE POLICY "Users can update own data" ON users
     FOR UPDATE USING (auth.uid()::text = id);
   
   -- 商家只能访问自己的数据
   CREATE POLICY "Merchants can view own data" ON merchants
     FOR SELECT USING (auth.uid()::text = user_id);
   
   CREATE POLICY "Merchants can update own data" ON merchants
     FOR UPDATE USING (auth.uid()::text = user_id);
   
   -- 公开活动数据（只读）
   CREATE POLICY "Public events are viewable" ON events
     FOR SELECT USING (status = 'published');
   
   -- 管理员权限（使用 service_role）
   CREATE POLICY "Admin full access" ON users
     FOR ALL USING (true);
   ```

### Stripe 配置

1. **设置 Webhook 端点**：
   - URL: `https://your-domain.com/api/stripe/webhook`
   - 事件: `checkout.session.completed`

2. **验证 Webhook 签名**：
   - 确保 `STRIPE_WEBHOOK_SECRET` 正确配置

### 安全检查清单

- [ ] 所有环境变量已正确设置
- [ ] Supabase RLS 策略已启用
- [ ] Stripe Webhook 已配置
- [ ] 生产环境 URL 已更新
- [ ] 数据库迁移已同步
- [ ] 所有 API 使用正确的认证方式

## 部署步骤

1. **推送代码到 Git 仓库**
2. **在 Vercel 中导入项目**
3. **设置环境变量**
4. **部署项目**
5. **验证所有功能正常工作**

## 故障排除

### 常见问题

1. **环境变量未生效**：
   - 检查 Vercel 环境变量设置
   - 重新部署项目

2. **Supabase 连接失败**：
   - 验证 URL 和密钥
   - 检查 RLS 策略

3. **Stripe 支付失败**：
   - 验证 Webhook 配置
   - 检查密钥设置

### 监控和日志

- 使用 Vercel Analytics 监控性能
- 检查 Supabase 日志
- 监控 Stripe 事件日志
