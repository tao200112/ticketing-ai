# 🔧 部署安全修复计划

**项目**: Next.js + Supabase + Stripe 票务系统  
**修复时间**: 2025年1月25日  
**优先级**: 高 → 中 → 低

---

## 🚨 高优先级修复（立即执行）

### 修复提案 #1 - Supabase认证系统重构
**文件**: `lib/supabase.ts`

**问题**: 未使用 createServerClient，认证不安全

**修复建议**:
```typescript
import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'

export function createClient() {
  const cookieStore = cookies()
  
  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll()
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            )
          } catch {
            // The `setAll` method was called from a Server Component.
            // This can be ignored if you have middleware refreshing
            // user sessions.
          }
        },
      },
    }
  )
}
```

**逻辑说明**: 使用SSR会话管理，避免Edge Runtime丢失session，确保认证安全。

**影响范围**: 所有认证相关功能，登录、注册、会话同步。

---

### 修复提案 #2 - 认证API路由重构
**文件**: `app/api/auth/login/route.js`

**问题**: 未使用createServerClient，缺少runtime配置

**修复建议**:
```javascript
import { createClient } from '../../../../lib/supabase'
import { NextResponse } from 'next/server'

export const runtime = 'nodejs'

export async function POST(request) {
  try {
    const { email, password } = await request.json()
    const supabase = createClient()
    
    // 使用Supabase Auth API而不是直接查询用户表
    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password,
    })
    
    if (error) {
      return NextResponse.json(
        { message: error.message },
        { status: 401 }
      )
    }
    
    return NextResponse.json({
      ok: true,
      user: data.user,
      session: data.session
    })
  } catch (error) {
    return NextResponse.json(
      { message: 'Server error' },
      { status: 500 }
    )
  }
}
```

**逻辑说明**: 使用Supabase Auth API替代直接数据库查询，确保认证安全。

**影响范围**: 用户登录、会话管理。

---

### 修复提案 #3 - 管理员API权限验证
**文件**: `app/api/admin/orders/route.js`

**问题**: 无身份验证，任何人都可以访问管理员数据

**修复建议**:
```javascript
import { NextResponse } from 'next/server'
import { createClient } from '../../../../lib/supabase'
import { supabaseAdmin } from '../../../../lib/supabase-admin'

export const runtime = 'nodejs'

// 管理员身份验证中间件
async function verifyAdmin(request) {
  const supabase = createClient()
  
  // 检查用户是否已登录
  const { data: { user }, error: authError } = await supabase.auth.getUser()
  
  if (authError || !user) {
    return { error: 'Unauthorized', status: 401 }
  }
  
  // 检查用户是否为管理员
  const { data: userData, error: userError } = await supabaseAdmin
    .from('users')
    .select('role')
    .eq('id', user.id)
    .single()
  
  if (userError || userData?.role !== 'admin') {
    return { error: 'Admin access required', status: 403 }
  }
  
  return { user }
}

export async function GET(request) {
  try {
    // 验证管理员权限
    const authResult = await verifyAdmin(request)
    if (authResult.error) {
      return NextResponse.json(
        { error: authResult.error },
        { status: authResult.status }
      )
    }
    
    // 原有逻辑
    const { data: orders, error } = await supabaseAdmin
      .from('orders')
      .select(`
        *,
        tickets (*)
      `)
      .order('created_at', { ascending: false })

    if (error) {
      console.error('[AdminOrders] Orders fetch error:', error)
      return NextResponse.json(
        { error: 'Failed to fetch orders' },
        { status: 500 }
      )
    }

    return NextResponse.json(orders || [])
  } catch (error) {
    console.error('[AdminOrders] Error fetching orders:', error)
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    )
  }
}
```

**逻辑说明**: 添加管理员身份验证中间件，确保只有管理员可以访问敏感数据。

**影响范围**: 所有管理员API，数据安全。

---

### 修复提案 #4 - 商家注册API安全修复
**文件**: `app/api/auth/register/route.js`

**问题**: 使用anonym key插入数据，可能绕过RLS

**修复建议**:
```javascript
import { NextResponse } from 'next/server'
import { createClient } from '../../../../lib/supabase'
import { supabaseAdmin } from '../../../../lib/supabase-admin'

export const runtime = 'nodejs'

export async function POST(request) {
  try {
    const { email, name, age, password } = await request.json()
    
    // 使用Supabase Auth API创建用户
    const supabase = createClient()
    
    const { data, error } = await supabase.auth.signUp({
      email,
      password,
      options: {
        data: {
          name,
          age: parseInt(age)
        }
      }
    })
    
    if (error) {
      return NextResponse.json(
        { message: error.message },
        { status: 400 }
      )
    }
    
    // 使用service role key更新用户角色
    if (data.user) {
      const { error: updateError } = await supabaseAdmin
        .from('users')
        .update({ role: 'merchant' })
        .eq('id', data.user.id)
      
      if (updateError) {
        console.error('Failed to update user role:', updateError)
      }
    }
    
    return NextResponse.json({
      ok: true,
      user: data.user,
      session: data.session
    })
  } catch (error) {
    console.error('Registration API error:', error)
    return NextResponse.json(
      { message: 'Server error' },
      { status: 500 }
    )
  }
}
```

**逻辑说明**: 使用Supabase Auth API创建用户，使用service role key更新角色，确保安全。

**影响范围**: 商家注册、用户角色管理。

---

### 修复提案 #5 - 启用RLS策略
**文件**: `supabase/migrations/enable_rls_policies.sql`

**问题**: RLS策略被注释，数据库无行级安全保护

**修复建议**:
```sql
-- 启用RLS
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE merchants ENABLE ROW LEVEL SECURITY;
ALTER TABLE events ENABLE ROW LEVEL SECURITY;
ALTER TABLE prices ENABLE ROW LEVEL SECURITY;
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE tickets ENABLE ROW LEVEL SECURITY;

-- Users RLS 策略
CREATE POLICY "Users can view and update own profile" ON users
    FOR ALL USING (id = auth.uid());

-- Merchants RLS 策略
CREATE POLICY "Merchants can manage their own business" ON merchants
    FOR ALL USING (owner_user_id = auth.uid());

CREATE POLICY "Verified merchants are publicly readable" ON merchants
    FOR SELECT USING (verified = true);

-- Events RLS 策略
CREATE POLICY "Events are publicly readable when published" ON events
    FOR SELECT USING (status = 'published');

CREATE POLICY "Merchants can manage their own events" ON events
    FOR ALL USING (
        merchant_id IN (
            SELECT id FROM merchants WHERE owner_user_id = auth.uid()
        )
    );

-- Prices RLS 策略
CREATE POLICY "Prices are publicly readable when active" ON prices
    FOR SELECT USING (is_active = true);

CREATE POLICY "Merchants can manage their event prices" ON prices
    FOR ALL USING (
        event_id IN (
            SELECT e.id FROM events e
            JOIN merchants m ON e.merchant_id = m.id
            WHERE m.owner_user_id = auth.uid()
        )
    );

-- Orders RLS 策略
CREATE POLICY "Users can view their own orders" ON orders
    FOR SELECT USING (customer_email = auth.email());

-- Tickets RLS 策略
CREATE POLICY "Users can view their own tickets" ON tickets
    FOR SELECT USING (
        order_id IN (
            SELECT id FROM orders WHERE customer_email = auth.email()
        )
    );
```

**逻辑说明**: 启用行级安全策略，确保用户只能访问自己的数据，商家只能管理自己的业务。

**影响范围**: 整个数据库安全，数据访问控制。

---

## ⚠️ 中优先级修复（2周内执行）

### 修复提案 #6 - API路由运行时配置
**文件**: `app/api/events/route.ts`

**问题**: 缺少runtime配置，可能影响数据库连接

**修复建议**:
```typescript
import { NextResponse } from 'next/server'
import { supabaseAdmin } from '../../../lib/supabase-admin'

export const dynamic = 'force-dynamic'
export const runtime = 'nodejs'  // 添加这行

// 其余代码保持不变
```

**逻辑说明**: 确保API路由在Node.js运行时执行，避免Edge Runtime兼容性问题。

**影响范围**: 所有数据库相关API，性能优化。

---

### 修复提案 #7 - 票据验证API权限检查
**文件**: `app/api/tickets/verify/route.js`

**问题**: 使用supabaseAdmin无限制访问

**修复建议**:
```javascript
import { NextResponse } from 'next/server'
import { createClient } from '../../../../lib/supabase'
import { supabaseAdmin } from '../../../../lib/supabase-admin'

export const runtime = 'nodejs'

// 验证商家权限
async function verifyMerchant(request) {
  const supabase = createClient()
  
  const { data: { user }, error: authError } = await supabase.auth.getUser()
  
  if (authError || !user) {
    return { error: 'Unauthorized', status: 401 }
  }
  
  // 检查用户是否为商家或管理员
  const { data: userData, error: userError } = await supabaseAdmin
    .from('users')
    .select('role')
    .eq('id', user.id)
    .single()
  
  if (userError || !['merchant', 'admin'].includes(userData?.role)) {
    return { error: 'Merchant access required', status: 403 }
  }
  
  return { user }
}

export async function POST(request) {
  try {
    // 验证商家权限
    const authResult = await verifyMerchant(request)
    if (authResult.error) {
      return NextResponse.json(
        { error: authResult.error },
        { status: authResult.status }
      )
    }
    
    // 原有票据验证逻辑
    const body = await request.json()
    // ... 其余代码保持不变
  } catch (error) {
    // 错误处理
  }
}
```

**逻辑说明**: 添加商家权限验证，确保只有商家和管理员可以验证票据。

**影响范围**: 票据验证功能，商家权限控制。

---

### 修复提案 #8 - 环境变量配置
**文件**: `.env.local`

**问题**: 本地环境变量文件缺失

**修复建议**:
```bash
# Supabase配置
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key

# Stripe配置
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=your_stripe_publishable_key
STRIPE_SECRET_KEY=your_stripe_secret_key
STRIPE_WEBHOOK_SECRET=your_stripe_webhook_secret
```

**逻辑说明**: 创建本地环境变量文件，确保开发环境配置完整。

**影响范围**: 本地开发环境，环境变量管理。

---

### 修复提案 #9 - Vercel部署配置
**文件**: `vercel.json`

**问题**: 缺少环境变量配置

**修复建议**:
```json
{
  "buildCommand": "npm run build",
  "outputDirectory": ".next",
  "framework": "nextjs",
  "installCommand": "npm install",
  "devCommand": "npm run dev",
  "env": {
    "NEXT_PUBLIC_SUPABASE_URL": "@supabase_url",
    "NEXT_PUBLIC_SUPABASE_ANON_KEY": "@supabase_anon_key",
    "SUPABASE_SERVICE_ROLE_KEY": "@supabase_service_role_key",
    "NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY": "@stripe_publishable_key",
    "STRIPE_SECRET_KEY": "@stripe_secret_key",
    "STRIPE_WEBHOOK_SECRET": "@stripe_webhook_secret"
  }
}
```

**逻辑说明**: 在Vercel配置中定义环境变量，确保生产环境配置正确。

**影响范围**: 生产环境部署，环境变量管理。

---

## 📋 修复执行计划

### 第一阶段（立即执行）
1. **修复提案 #1** - Supabase认证系统重构
2. **修复提案 #2** - 认证API路由重构
3. **修复提案 #3** - 管理员API权限验证
4. **修复提案 #4** - 商家注册API安全修复
5. **修复提案 #5** - 启用RLS策略

### 第二阶段（2周内）
6. **修复提案 #6** - API路由运行时配置
7. **修复提案 #7** - 票据验证API权限检查
8. **修复提案 #8** - 环境变量配置
9. **修复提案 #9** - Vercel部署配置

### 第三阶段（1个月内）
10. 安全审计
11. 监控系统
12. 文档完善

---

## 🎯 执行指令

要执行修复，请按以下格式输入：

```
确认修复 #1
确认修复 #2
确认修复 #3
...
```

或者批量执行：
```
确认修复 #1-5
```

**⚠️ 重要提醒**: 
- 修复前请备份当前代码
- 建议在测试环境先验证修复效果
- 修复后需要重新部署到生产环境

---

**📞 技术支持**: 如需详细指导，请联系开发团队。
