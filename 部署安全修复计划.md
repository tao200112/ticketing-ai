# ğŸ”§ éƒ¨ç½²å®‰å…¨ä¿®å¤è®¡åˆ’

**é¡¹ç›®**: Next.js + Supabase + Stripe ç¥¨åŠ¡ç³»ç»Ÿ  
**ä¿®å¤æ—¶é—´**: 2025å¹´1æœˆ25æ—¥  
**ä¼˜å…ˆçº§**: é«˜ â†’ ä¸­ â†’ ä½

---

## ğŸš¨ é«˜ä¼˜å…ˆçº§ä¿®å¤ï¼ˆç«‹å³æ‰§è¡Œï¼‰

### ä¿®å¤ææ¡ˆ #1 - Supabaseè®¤è¯ç³»ç»Ÿé‡æ„
**æ–‡ä»¶**: `lib/supabase.ts`

**é—®é¢˜**: æœªä½¿ç”¨ createServerClientï¼Œè®¤è¯ä¸å®‰å…¨

**ä¿®å¤å»ºè®®**:
```typescript
import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'

export function createClient() {
  const cookieStore = cookies()
  
  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll()
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            )
          } catch {
            // The `setAll` method was called from a Server Component.
            // This can be ignored if you have middleware refreshing
            // user sessions.
          }
        },
      },
    }
  )
}
```

**é€»è¾‘è¯´æ˜**: ä½¿ç”¨SSRä¼šè¯ç®¡ç†ï¼Œé¿å…Edge Runtimeä¸¢å¤±sessionï¼Œç¡®ä¿è®¤è¯å®‰å…¨ã€‚

**å½±å“èŒƒå›´**: æ‰€æœ‰è®¤è¯ç›¸å…³åŠŸèƒ½ï¼Œç™»å½•ã€æ³¨å†Œã€ä¼šè¯åŒæ­¥ã€‚

---

### ä¿®å¤ææ¡ˆ #2 - è®¤è¯APIè·¯ç”±é‡æ„
**æ–‡ä»¶**: `app/api/auth/login/route.js`

**é—®é¢˜**: æœªä½¿ç”¨createServerClientï¼Œç¼ºå°‘runtimeé…ç½®

**ä¿®å¤å»ºè®®**:
```javascript
import { createClient } from '../../../../lib/supabase'
import { NextResponse } from 'next/server'

export const runtime = 'nodejs'

export async function POST(request) {
  try {
    const { email, password } = await request.json()
    const supabase = createClient()
    
    // ä½¿ç”¨Supabase Auth APIè€Œä¸æ˜¯ç›´æ¥æŸ¥è¯¢ç”¨æˆ·è¡¨
    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password,
    })
    
    if (error) {
      return NextResponse.json(
        { message: error.message },
        { status: 401 }
      )
    }
    
    return NextResponse.json({
      ok: true,
      user: data.user,
      session: data.session
    })
  } catch (error) {
    return NextResponse.json(
      { message: 'Server error' },
      { status: 500 }
    )
  }
}
```

**é€»è¾‘è¯´æ˜**: ä½¿ç”¨Supabase Auth APIæ›¿ä»£ç›´æ¥æ•°æ®åº“æŸ¥è¯¢ï¼Œç¡®ä¿è®¤è¯å®‰å…¨ã€‚

**å½±å“èŒƒå›´**: ç”¨æˆ·ç™»å½•ã€ä¼šè¯ç®¡ç†ã€‚

---

### ä¿®å¤ææ¡ˆ #3 - ç®¡ç†å‘˜APIæƒé™éªŒè¯
**æ–‡ä»¶**: `app/api/admin/orders/route.js`

**é—®é¢˜**: æ— èº«ä»½éªŒè¯ï¼Œä»»ä½•äººéƒ½å¯ä»¥è®¿é—®ç®¡ç†å‘˜æ•°æ®

**ä¿®å¤å»ºè®®**:
```javascript
import { NextResponse } from 'next/server'
import { createClient } from '../../../../lib/supabase'
import { supabaseAdmin } from '../../../../lib/supabase-admin'

export const runtime = 'nodejs'

// ç®¡ç†å‘˜èº«ä»½éªŒè¯ä¸­é—´ä»¶
async function verifyAdmin(request) {
  const supabase = createClient()
  
  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
  const { data: { user }, error: authError } = await supabase.auth.getUser()
  
  if (authError || !user) {
    return { error: 'Unauthorized', status: 401 }
  }
  
  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºç®¡ç†å‘˜
  const { data: userData, error: userError } = await supabaseAdmin
    .from('users')
    .select('role')
    .eq('id', user.id)
    .single()
  
  if (userError || userData?.role !== 'admin') {
    return { error: 'Admin access required', status: 403 }
  }
  
  return { user }
}

export async function GET(request) {
  try {
    // éªŒè¯ç®¡ç†å‘˜æƒé™
    const authResult = await verifyAdmin(request)
    if (authResult.error) {
      return NextResponse.json(
        { error: authResult.error },
        { status: authResult.status }
      )
    }
    
    // åŸæœ‰é€»è¾‘
    const { data: orders, error } = await supabaseAdmin
      .from('orders')
      .select(`
        *,
        tickets (*)
      `)
      .order('created_at', { ascending: false })

    if (error) {
      console.error('[AdminOrders] Orders fetch error:', error)
      return NextResponse.json(
        { error: 'Failed to fetch orders' },
        { status: 500 }
      )
    }

    return NextResponse.json(orders || [])
  } catch (error) {
    console.error('[AdminOrders] Error fetching orders:', error)
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    )
  }
}
```

**é€»è¾‘è¯´æ˜**: æ·»åŠ ç®¡ç†å‘˜èº«ä»½éªŒè¯ä¸­é—´ä»¶ï¼Œç¡®ä¿åªæœ‰ç®¡ç†å‘˜å¯ä»¥è®¿é—®æ•æ„Ÿæ•°æ®ã€‚

**å½±å“èŒƒå›´**: æ‰€æœ‰ç®¡ç†å‘˜APIï¼Œæ•°æ®å®‰å…¨ã€‚

---

### ä¿®å¤ææ¡ˆ #4 - å•†å®¶æ³¨å†ŒAPIå®‰å…¨ä¿®å¤
**æ–‡ä»¶**: `app/api/auth/register/route.js`

**é—®é¢˜**: ä½¿ç”¨anonym keyæ’å…¥æ•°æ®ï¼Œå¯èƒ½ç»•è¿‡RLS

**ä¿®å¤å»ºè®®**:
```javascript
import { NextResponse } from 'next/server'
import { createClient } from '../../../../lib/supabase'
import { supabaseAdmin } from '../../../../lib/supabase-admin'

export const runtime = 'nodejs'

export async function POST(request) {
  try {
    const { email, name, age, password } = await request.json()
    
    // ä½¿ç”¨Supabase Auth APIåˆ›å»ºç”¨æˆ·
    const supabase = createClient()
    
    const { data, error } = await supabase.auth.signUp({
      email,
      password,
      options: {
        data: {
          name,
          age: parseInt(age)
        }
      }
    })
    
    if (error) {
      return NextResponse.json(
        { message: error.message },
        { status: 400 }
      )
    }
    
    // ä½¿ç”¨service role keyæ›´æ–°ç”¨æˆ·è§’è‰²
    if (data.user) {
      const { error: updateError } = await supabaseAdmin
        .from('users')
        .update({ role: 'merchant' })
        .eq('id', data.user.id)
      
      if (updateError) {
        console.error('Failed to update user role:', updateError)
      }
    }
    
    return NextResponse.json({
      ok: true,
      user: data.user,
      session: data.session
    })
  } catch (error) {
    console.error('Registration API error:', error)
    return NextResponse.json(
      { message: 'Server error' },
      { status: 500 }
    )
  }
}
```

**é€»è¾‘è¯´æ˜**: ä½¿ç”¨Supabase Auth APIåˆ›å»ºç”¨æˆ·ï¼Œä½¿ç”¨service role keyæ›´æ–°è§’è‰²ï¼Œç¡®ä¿å®‰å…¨ã€‚

**å½±å“èŒƒå›´**: å•†å®¶æ³¨å†Œã€ç”¨æˆ·è§’è‰²ç®¡ç†ã€‚

---

### ä¿®å¤ææ¡ˆ #5 - å¯ç”¨RLSç­–ç•¥
**æ–‡ä»¶**: `supabase/migrations/enable_rls_policies.sql`

**é—®é¢˜**: RLSç­–ç•¥è¢«æ³¨é‡Šï¼Œæ•°æ®åº“æ— è¡Œçº§å®‰å…¨ä¿æŠ¤

**ä¿®å¤å»ºè®®**:
```sql
-- å¯ç”¨RLS
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE merchants ENABLE ROW LEVEL SECURITY;
ALTER TABLE events ENABLE ROW LEVEL SECURITY;
ALTER TABLE prices ENABLE ROW LEVEL SECURITY;
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE tickets ENABLE ROW LEVEL SECURITY;

-- Users RLS ç­–ç•¥
CREATE POLICY "Users can view and update own profile" ON users
    FOR ALL USING (id = auth.uid());

-- Merchants RLS ç­–ç•¥
CREATE POLICY "Merchants can manage their own business" ON merchants
    FOR ALL USING (owner_user_id = auth.uid());

CREATE POLICY "Verified merchants are publicly readable" ON merchants
    FOR SELECT USING (verified = true);

-- Events RLS ç­–ç•¥
CREATE POLICY "Events are publicly readable when published" ON events
    FOR SELECT USING (status = 'published');

CREATE POLICY "Merchants can manage their own events" ON events
    FOR ALL USING (
        merchant_id IN (
            SELECT id FROM merchants WHERE owner_user_id = auth.uid()
        )
    );

-- Prices RLS ç­–ç•¥
CREATE POLICY "Prices are publicly readable when active" ON prices
    FOR SELECT USING (is_active = true);

CREATE POLICY "Merchants can manage their event prices" ON prices
    FOR ALL USING (
        event_id IN (
            SELECT e.id FROM events e
            JOIN merchants m ON e.merchant_id = m.id
            WHERE m.owner_user_id = auth.uid()
        )
    );

-- Orders RLS ç­–ç•¥
CREATE POLICY "Users can view their own orders" ON orders
    FOR SELECT USING (customer_email = auth.email());

-- Tickets RLS ç­–ç•¥
CREATE POLICY "Users can view their own tickets" ON tickets
    FOR SELECT USING (
        order_id IN (
            SELECT id FROM orders WHERE customer_email = auth.email()
        )
    );
```

**é€»è¾‘è¯´æ˜**: å¯ç”¨è¡Œçº§å®‰å…¨ç­–ç•¥ï¼Œç¡®ä¿ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®ï¼Œå•†å®¶åªèƒ½ç®¡ç†è‡ªå·±çš„ä¸šåŠ¡ã€‚

**å½±å“èŒƒå›´**: æ•´ä¸ªæ•°æ®åº“å®‰å…¨ï¼Œæ•°æ®è®¿é—®æ§åˆ¶ã€‚

---

## âš ï¸ ä¸­ä¼˜å…ˆçº§ä¿®å¤ï¼ˆ2å‘¨å†…æ‰§è¡Œï¼‰

### ä¿®å¤ææ¡ˆ #6 - APIè·¯ç”±è¿è¡Œæ—¶é…ç½®
**æ–‡ä»¶**: `app/api/events/route.ts`

**é—®é¢˜**: ç¼ºå°‘runtimeé…ç½®ï¼Œå¯èƒ½å½±å“æ•°æ®åº“è¿æ¥

**ä¿®å¤å»ºè®®**:
```typescript
import { NextResponse } from 'next/server'
import { supabaseAdmin } from '../../../lib/supabase-admin'

export const dynamic = 'force-dynamic'
export const runtime = 'nodejs'  // æ·»åŠ è¿™è¡Œ

// å…¶ä½™ä»£ç ä¿æŒä¸å˜
```

**é€»è¾‘è¯´æ˜**: ç¡®ä¿APIè·¯ç”±åœ¨Node.jsè¿è¡Œæ—¶æ‰§è¡Œï¼Œé¿å…Edge Runtimeå…¼å®¹æ€§é—®é¢˜ã€‚

**å½±å“èŒƒå›´**: æ‰€æœ‰æ•°æ®åº“ç›¸å…³APIï¼Œæ€§èƒ½ä¼˜åŒ–ã€‚

---

### ä¿®å¤ææ¡ˆ #7 - ç¥¨æ®éªŒè¯APIæƒé™æ£€æŸ¥
**æ–‡ä»¶**: `app/api/tickets/verify/route.js`

**é—®é¢˜**: ä½¿ç”¨supabaseAdminæ— é™åˆ¶è®¿é—®

**ä¿®å¤å»ºè®®**:
```javascript
import { NextResponse } from 'next/server'
import { createClient } from '../../../../lib/supabase'
import { supabaseAdmin } from '../../../../lib/supabase-admin'

export const runtime = 'nodejs'

// éªŒè¯å•†å®¶æƒé™
async function verifyMerchant(request) {
  const supabase = createClient()
  
  const { data: { user }, error: authError } = await supabase.auth.getUser()
  
  if (authError || !user) {
    return { error: 'Unauthorized', status: 401 }
  }
  
  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºå•†å®¶æˆ–ç®¡ç†å‘˜
  const { data: userData, error: userError } = await supabaseAdmin
    .from('users')
    .select('role')
    .eq('id', user.id)
    .single()
  
  if (userError || !['merchant', 'admin'].includes(userData?.role)) {
    return { error: 'Merchant access required', status: 403 }
  }
  
  return { user }
}

export async function POST(request) {
  try {
    // éªŒè¯å•†å®¶æƒé™
    const authResult = await verifyMerchant(request)
    if (authResult.error) {
      return NextResponse.json(
        { error: authResult.error },
        { status: authResult.status }
      )
    }
    
    // åŸæœ‰ç¥¨æ®éªŒè¯é€»è¾‘
    const body = await request.json()
    // ... å…¶ä½™ä»£ç ä¿æŒä¸å˜
  } catch (error) {
    // é”™è¯¯å¤„ç†
  }
}
```

**é€»è¾‘è¯´æ˜**: æ·»åŠ å•†å®¶æƒé™éªŒè¯ï¼Œç¡®ä¿åªæœ‰å•†å®¶å’Œç®¡ç†å‘˜å¯ä»¥éªŒè¯ç¥¨æ®ã€‚

**å½±å“èŒƒå›´**: ç¥¨æ®éªŒè¯åŠŸèƒ½ï¼Œå•†å®¶æƒé™æ§åˆ¶ã€‚

---

### ä¿®å¤ææ¡ˆ #8 - ç¯å¢ƒå˜é‡é…ç½®
**æ–‡ä»¶**: `.env.local`

**é—®é¢˜**: æœ¬åœ°ç¯å¢ƒå˜é‡æ–‡ä»¶ç¼ºå¤±

**ä¿®å¤å»ºè®®**:
```bash
# Supabaseé…ç½®
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key

# Stripeé…ç½®
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=your_stripe_publishable_key
STRIPE_SECRET_KEY=your_stripe_secret_key
STRIPE_WEBHOOK_SECRET=your_stripe_webhook_secret
```

**é€»è¾‘è¯´æ˜**: åˆ›å»ºæœ¬åœ°ç¯å¢ƒå˜é‡æ–‡ä»¶ï¼Œç¡®ä¿å¼€å‘ç¯å¢ƒé…ç½®å®Œæ•´ã€‚

**å½±å“èŒƒå›´**: æœ¬åœ°å¼€å‘ç¯å¢ƒï¼Œç¯å¢ƒå˜é‡ç®¡ç†ã€‚

---

### ä¿®å¤ææ¡ˆ #9 - Verceléƒ¨ç½²é…ç½®
**æ–‡ä»¶**: `vercel.json`

**é—®é¢˜**: ç¼ºå°‘ç¯å¢ƒå˜é‡é…ç½®

**ä¿®å¤å»ºè®®**:
```json
{
  "buildCommand": "npm run build",
  "outputDirectory": ".next",
  "framework": "nextjs",
  "installCommand": "npm install",
  "devCommand": "npm run dev",
  "env": {
    "NEXT_PUBLIC_SUPABASE_URL": "@supabase_url",
    "NEXT_PUBLIC_SUPABASE_ANON_KEY": "@supabase_anon_key",
    "SUPABASE_SERVICE_ROLE_KEY": "@supabase_service_role_key",
    "NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY": "@stripe_publishable_key",
    "STRIPE_SECRET_KEY": "@stripe_secret_key",
    "STRIPE_WEBHOOK_SECRET": "@stripe_webhook_secret"
  }
}
```

**é€»è¾‘è¯´æ˜**: åœ¨Vercelé…ç½®ä¸­å®šä¹‰ç¯å¢ƒå˜é‡ï¼Œç¡®ä¿ç”Ÿäº§ç¯å¢ƒé…ç½®æ­£ç¡®ã€‚

**å½±å“èŒƒå›´**: ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ï¼Œç¯å¢ƒå˜é‡ç®¡ç†ã€‚

---

## ğŸ“‹ ä¿®å¤æ‰§è¡Œè®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼ˆç«‹å³æ‰§è¡Œï¼‰
1. **ä¿®å¤ææ¡ˆ #1** - Supabaseè®¤è¯ç³»ç»Ÿé‡æ„
2. **ä¿®å¤ææ¡ˆ #2** - è®¤è¯APIè·¯ç”±é‡æ„
3. **ä¿®å¤ææ¡ˆ #3** - ç®¡ç†å‘˜APIæƒé™éªŒè¯
4. **ä¿®å¤ææ¡ˆ #4** - å•†å®¶æ³¨å†ŒAPIå®‰å…¨ä¿®å¤
5. **ä¿®å¤ææ¡ˆ #5** - å¯ç”¨RLSç­–ç•¥

### ç¬¬äºŒé˜¶æ®µï¼ˆ2å‘¨å†…ï¼‰
6. **ä¿®å¤ææ¡ˆ #6** - APIè·¯ç”±è¿è¡Œæ—¶é…ç½®
7. **ä¿®å¤ææ¡ˆ #7** - ç¥¨æ®éªŒè¯APIæƒé™æ£€æŸ¥
8. **ä¿®å¤ææ¡ˆ #8** - ç¯å¢ƒå˜é‡é…ç½®
9. **ä¿®å¤ææ¡ˆ #9** - Verceléƒ¨ç½²é…ç½®

### ç¬¬ä¸‰é˜¶æ®µï¼ˆ1ä¸ªæœˆå†…ï¼‰
10. å®‰å…¨å®¡è®¡
11. ç›‘æ§ç³»ç»Ÿ
12. æ–‡æ¡£å®Œå–„

---

## ğŸ¯ æ‰§è¡ŒæŒ‡ä»¤

è¦æ‰§è¡Œä¿®å¤ï¼Œè¯·æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å…¥ï¼š

```
ç¡®è®¤ä¿®å¤ #1
ç¡®è®¤ä¿®å¤ #2
ç¡®è®¤ä¿®å¤ #3
...
```

æˆ–è€…æ‰¹é‡æ‰§è¡Œï¼š
```
ç¡®è®¤ä¿®å¤ #1-5
```

**âš ï¸ é‡è¦æé†’**: 
- ä¿®å¤å‰è¯·å¤‡ä»½å½“å‰ä»£ç 
- å»ºè®®åœ¨æµ‹è¯•ç¯å¢ƒå…ˆéªŒè¯ä¿®å¤æ•ˆæœ
- ä¿®å¤åéœ€è¦é‡æ–°éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

---

**ğŸ“ æŠ€æœ¯æ”¯æŒ**: å¦‚éœ€è¯¦ç»†æŒ‡å¯¼ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿã€‚
